\documentclass{article}
\usepackage{amsmath}
\usepackage{tikz}
\usetikzlibrary{trees}
\usepackage{graphicx}
\usepackage[english,greek]{babel}
\usepackage{listings}
\usepackage{array}
\usepackage{float}

\newcommand{\includeimage}[2]{
    \begin{figure}[H]
        \centering
        \includegraphics[width=\linewidth]{#1}
        \if\relax\detokenize{#2}\relax
            % Do nothing if #2 is empty
        \else
            \caption{#2}
        \fi
    \end{figure}
}

\begin{document}
\title{$Project$ ΗΥ-360}
\author{Δρακάκης Ραφαήλ $csd5310$\\Άγγελος-Τίτος Δήμογλης $csd5078$\\Κωνσταντίνος Κουναλάκης $csd5058$}
\date{}
\maketitle
\section*{1η φάση}
Η πρώτη φάση αφορά την δημιουργία ενός πλήρους εννοιολογικού μοντέλου.
\subsection*{$E-R$ Διάγραμμα}
\includeimage{E-R.png}{Το ζητούμενο διάγραμμα}
Στο διάγραμμα φαίνονται τα γνωρίσματα όλων των οντοτήτων και σχέσεων και τα πρωτεύοντα κλειδιά\\
Σχετικά με τα γνωρίσματα και τις σχέσεις έχουμε:\\
Μια σχέση $contains$ ανάμεσα στο $ticket$ και το $reservation$, και μια σχέση $Makes$ ανάμεσα στον $customer$ και το $reservation$.\\
Οι περιορισμοί για τις πληθικότητες φαίνονται στο σχήμα
\subsection*{Μετάφραση στο σχεσιακό μοντέλο}
Παρακάτω φαίνονται οι πίνακες για το σχεσιακό μοντέλο\\
% Table 1: Customer
\noindent
\begin{tabular}{|c|c|c|c|c|}
\hline
\multicolumn{5}{|c|}{$Customer$} \\
\hline
$cid$ & $mail$ & $credit\_info$ & $f\_name$ & $l\_name$ \\
\hline
& & & & \\
\hline
\end{tabular}

\vspace{10pt}

% Table 2: Event
\noindent
\begin{tabular}{|c|c|c|c|c|c|}
\hline
\multicolumn{6}{|c|}{$Event$} \\
\hline
$eid$ & $name$ & $type$ & $time$ & $date$ & $capacity$ \\
\hline
& & & & & \\
\hline
\end{tabular}

\vspace{10pt}

% Table 3: Ticket
\noindent
\begin{tabular}{|c|c|c|c|c|}
\hline
\multicolumn{5}{|c|}{$Ticket$} \\
\hline
$tid$ & $type$ & $price$ & $availability$ & $seat\_number$ \\
\hline
& & & & \\
\hline
\end{tabular}

\vspace{10pt}

% Table 4: Reservation
\noindent
\begin{tabular}{|c|c|c|c|c|c|}
\hline
\multicolumn{6}{|c|}{$Reservation$} \\
\hline
$rid$ & $eid$ & $cid$ & $date$ & $total\_price$ & $tickets\_number$ \\
\hline
& & & & & \\
\hline
\end{tabular}

\vspace{10pt}

% Relations

% Relation: Contains (Event and Ticket)
\noindent
\begin{tabular}{|c|c|}
\hline
\multicolumn{2}{|c|}{$Contains$} \\
\hline
$eid$ & $tid$ \\
\hline
& \\
\hline
\end{tabular}

\vspace{5pt}

% Relation: Makes (Customer and Reservation)
\noindent
\begin{tabular}{|c|c|}
\hline
\multicolumn{2}{|c|}{$Makes$} \\
\hline
$cid$ & $rid$ \\
\hline
& \\
\hline
\end{tabular}

\vspace{5pt}

% Relation: Has (Customer and Reservation)
\noindent
\begin{tabular}{|c|c|}
\hline
\multicolumn{2}{|c|}{$Has$} \\
\hline
$tid$ & $eid$ \\
\hline
& \\
\hline
\end{tabular}

\subsection*{Εντολές $SQL$ για τις σχέσεις που προκύπτουν}
\selectlanguage{english}
\begin{lstlisting}
CREATE TABLE Customer (
    cid INT PRIMARY KEY,
    mail VARCHAR(255) NOT NULL,
    credit_info VARCHAR(255),
    f_name VARCHAR(100),
    l_name VARCHAR(100)
);
\end{lstlisting}

\begin{lstlisting}
CREATE TABLE Event (
    eid INT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    type VARCHAR(100),
    time TIME,
    date DATE,
    capacity INT
);
\end{lstlisting}

\begin{lstlisting}
CREATE TABLE Ticket (
    tid INT PRIMARY KEY,
    type VARCHAR(100),
    price DECIMAL(10, 2),
    availability BOOLEAN DEFAULT TRUE,
    seat_number INT
);
\end{lstlisting}

\begin{lstlisting}
CREATE TABLE Reservation (
    rid INT PRIMARY KEY,
    eid INT,
    cid INT,
    date DATE,
    total_price DECIMAL(10, 2),
    tickets_number INT,
    FOREIGN KEY (eid) REFERENCES Event(eid),
    FOREIGN KEY (cid) REFERENCES Customer(cid)
);
\end{lstlisting}

\begin{lstlisting}
CREATE TABLE Contains (
    eid INT,
    tid INT,
    PRIMARY KEY (eid, tid),
    FOREIGN KEY (eid) REFERENCES Event(eid),
    FOREIGN KEY (tid) REFERENCES Ticket(tid)
);
\end{lstlisting}

\begin{lstlisting}
CREATE TABLE Makes (
    cid INT,
    rid INT,
    PRIMARY KEY (cid, rid),
    FOREIGN KEY (cid) REFERENCES Customer(cid),
    FOREIGN KEY (rid) REFERENCES Reservation(rid)
);
\end{lstlisting}

\begin{lstlisting}
CREATE TABLE Has (
    tid INT,
    eid INT,
    PRIMARY KEY (tid, eid),
    FOREIGN KEY (tid) REFERENCES Ticket(tid),
    FOREIGN KEY (eid) REFERENCES Event(eid)
);
\end{lstlisting}
\selectlanguage{greek}
\subsection*{Περιορισμοί Ακεραιότητας}
Οι περιορισμοί ακεραιότητας για την βάση δεδομένων περιλαμβάνουν τα εξής:
\begin{itemize}
    \item Πρωτεύοντα Κλειδιά
    \begin{itemize}
        \item $Customer(cid)$
        \item $Event(eid)$
        \item $Ticket(tid)$
        \item $Reservation(rid)$
    \end{itemize}
    \item Ξένα Κλειδιά
    \begin{itemize}
        \item Στον πίνακα $Reservation$, το πεδίο $eid$ αναφέρεται στον πίνακα $Event$.
        \item Στον πίνακα $Reservation$, το πεδίο $cid$ αναφέρεται στον πίνακα $Customer$.
        \item Στον πίνακα $Contains$, το πεδίο $tid$ αναφέρεται στον πίνακα $Ticket$.
    \end{itemize}
    \item Μοναδικότητα: Το πεδίο $mail$ στον πίνακα $Customer$ είναι μοναδικό για κάθε πελάτη.
    \item Υποχρεωτικά Πεδία: Τα πεδία $cid$ στον πίνακα $Customer$, $eid$ στον πίνακα $Event$, και $tid$ στον πίνακα $Ticket$ δεν επιτρέπουν κενές τιμές.
    \item Επιτρεπόμενες Τιμές: Οι τιμές του $price$ στον πίνακα $Ticket$ πρέπει να είναι θετικές.
\end{itemize}

\subsection*{Συναρτησιακές Εξαρτήσεις}
Οι συναρτησιακές εξαρτήσεις μεταξύ των πεδίων των πινάκων είναι οι εξής:
\begin{itemize}
    \item $cid \rightarrow mail, credit\_info, f\_name, l\_name$ (από τον πίνακα $Customer$)
    \item $eid \rightarrow name, type, time, date, capacity$ (από τον πίνακα $Event$)
    \item $tid \rightarrow type, price, availability, seat\_number$ (από τον πίνακα $Ticket$)
    \item $rid \rightarrow eid, cid, date, total\_price, tickets\_number$ (από τον πίνακα $Reservation$)
    \item $eid, tid \rightarrow tickets\_number$ (από τη σχέση $Contains$)
\end{itemize}

\subsection*{Μετατροπή σε Τρίτη Κανονική Μορφή}

\subsection*{Ερωτήματα $SQL$}
Ακολουθούν παραδείγματα $SQL$ ερωτημάτων για την βάση δεδομένων:
\begin{itemize}
    \item \textbf{Ερώτημα για την εύρεση όλων των κρατήσεων ενός πελάτη:}
    \selectlanguage{english}
    \begin{lstlisting}
    SELECT * FROM Reservation
    WHERE cid = 164; 
    \end{lstlisting}
    	\selectlanguage{greek}
    \item \textbf{Ερώτημα για την εύρεση όλων των διαθέσιμων εισιτηρίων για ένα γεγονός:}
    \selectlanguage{english}
    \begin{lstlisting}
    SELECT * FROM Ticket
    WHERE availability = TRUE AND eid = 163;
    \end{lstlisting}
	\selectlanguage{greek}
    \item \textbf{Ερώτημα για την εύρεση του συνολικού κόστους μιας κράτησης:}
    \selectlanguage{english}
    \begin{lstlisting}
    SELECT SUM(price) FROM Ticket
    JOIN Reservation ON Ticket.eid = Reservation.eid
    WHERE Reservation.rid = 924;
    \end{lstlisting}
    	\selectlanguage{greek}
\end{itemize}

\subsection*{Ψευδοκώδικας Διαδικασιών}
Ακολουθεί ψευδοκώδικας για την διαδικασία δημιουργίας μιας νέας κράτησης:
\selectlanguage{english}
\begin{lstlisting}
PROCEDURE ADD_CUSTOMER(email, credit_info, first_name, last_name):
    IF email is not empty AND first_name is not empty 
    		AND last_name is not empty:
        INSERT INTO Customer (email, credit_info, first_name, last_name)
        RETURN success
    ELSE:
        RETURN "Missing required fields"

PROCEDURE CREATE_RESERVATION(customer_id, event_id, ticket_count, total_price):
    IF ticket_count > 0 AND total_price > 0:
        CHECK IF event_capacity(event_id) >= ticket_count:
            INSERT INTO Reservation (customer_id, event_id, 
            		ticket_count, total_price)
            IF reservation is successful:
                UPDATE ticket availability for the event
                RETURN reservation ID
            ELSE:
                RETURN "Reservation failed"
        ELSE:
            RETURN "Not enough capacity"
    ELSE:
        RETURN "Invalid ticket count or price"

PROCEDURE UPDATE_TICKET_AVAILABILITY(ticket_id, availability):
    IF ticket_id exists AND availability is valid:
        UPDATE Ticket 
        SET availability = availability 
        WHERE ticket_id = ticket_id
        RETURN success
    ELSE:
        RETURN error "Invalid ticket ID or availability"

PROCEDURE CHECK_EVENT_CAPACITY(event_id):
    SELECT capacity 
    FROM Event 
    WHERE event_id = event_id
    RETURN capacity
    
PROCEDURE ASSIGN_TICKET_TO_EVENT(ticket_id, event_id):
    IF ticket_id exists AND event_id exists:
        INSERT INTO Has (ticket_id, event_id)
        RETURN success
    ELSE:
        RETURN "Invalid ticket or event"

PROCEDURE CANCEL_RESERVATION(reservation_id):
    IF reservation_id exists:
        DELETE FROM Reservation 
        WHERE reservation_id = reservation_id
        UPDATE ticket availability
        RETURN success
    ELSE:
        RETURN "Reservation not found"

PROCEDURE UPDATE_EVENT(event_id, new_capacity):
    IF event_id exists AND new_capacity > 0:
        UPDATE Event 
        SET capacity = new_capacity 
        WHERE event_id = event_id
        RETURN success
    ELSE:
        RETURN "Invalid event ID or capacity"
        
PROCEDURE GET_CUSTOMER_RESERVATIONS(customer_id):
    SELECT * 
    FROM Reservation 
    WHERE customer_id = customer_id
    RETURN reservation details

PROCEDURE GET_EVENT_TICKETS(event_id):
    SELECT * 
    FROM Ticket 
    WHERE event_id = event_id AND availability = TRUE
    RETURN available tickets

PROCEDURE GET_TOTAL_COST(reservation_id):
    SELECT SUM(price) 
    FROM Ticket 
    JOIN Reservation 
        ON Ticket.event_id = Reservation.event_id
    WHERE Reservation.reservation_id = reservation_id
    RETURN total cost

\end{lstlisting}
\selectlanguage{greek}
\section*{2η φάση}

\end{document}